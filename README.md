# ì˜ìƒ ê¸°ë°˜ ë†êµ¬ ì ìˆ˜ ìë™ ê¸°ë¡ AI ì„œë¹„ìŠ¤âœ¨
![](assets/final_inference.gif) 

*Read this in other languages: [English](README_en.md), [í•œêµ­ì–´](README.md)*

## ğŸ€ ë°°ê²½
&nbsp;ë†êµ¬ ê²½ê¸°ì—ì„œ ì„ ìˆ˜ê°€ ì–¼ë§ˆë‚˜ ê³¨ì„ ì˜ ë„£ì„ê¹Œ ìƒê°í•´ ë³´ì‹  ì ì´ ìˆë‚˜ìš”? ë§Œì•½ ì–´ë–¤ ì„ ìˆ˜ì˜ ì•¼íˆ¬ìœ¨ì„ ìˆ˜ì‘ì—…ìœ¼ë¡œ ê³„ì‚°í•œë‹¤ê³  í•˜ë©´ ë§ì€ ì‹œê°„ê³¼ ë…¸ë ¥ì´ í•„ìš”í•  ê²ƒì…ë‹ˆë‹¤. ê²Œë‹¤ê°€ ë°”ìœ í˜„ëŒ€ì¸ë“¤ì€ ë³¸ì¸ í˜¹ì€ ì„ ìˆ˜ë“¤ì— ëŒ€í•œ ëª¨ë“  ê²½ê¸° ì˜ìƒì„ ì‹œì²­í•˜ê³  ë¶„ì„í•  ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤. ì´ì²˜ëŸ¼ ë†êµ¬ ê²½ê¸°ì— ëŒ€í•´ ë¶„ì„í•˜ê³  ì‹¶ì§€ë§Œ, ì‹œê°„ì´ ì—†ì–´ ë§ì„¤ì´ëŠ” ì‚¬ëŒë“¤ì„ ìœ„í•´ ì €í¬ëŠ” ë”¥ëŸ¬ë‹ì„ ì‚¬ìš©í•œ ì˜ìƒ ê¸°ë°˜ ë†êµ¬ ì ìˆ˜ ìë™ ê¸°ë¡ AI ì„œë¹„ìŠ¤ë¥¼ ê°œë°œí–ˆìŠµë‹ˆë‹¤! ğŸ˜Š

## ğŸ§  ëª¨ë¸
 &nbsp;ìš°ë¦¬ëŠ” ëª©í‘œë¥¼ ë‹¬ì„±í•˜ê¸° ìœ„í•´ ë‘ ê°€ì§€ì˜ ëª¨ë¸ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ëª¨ë¸ì€ ì„ ìˆ˜, ê³µ, ê³¨ëŒ€, ìŠ›, ê³¨ì„ ê°ì§€í•˜ëŠ” ë° ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤. ë‘ ë²ˆì§¸ ëª¨ë¸ì€ í”„ë ˆì„ë³„ë¡œ ê°œì¸ì˜ idë¥¼ ì¶”ì í•˜ëŠ” ë° ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤. ì¦‰, ìš°ë¦¬ëŠ” ì•¼íˆ¬ìœ¨ ì¶”ì ê¸°ë¥¼ êµ¬í˜„í•˜ê¸° ìœ„í•´ Object Detectionê³¼ Person Re-Identification ëª¨ë¸ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. Object Detection ëª¨ë¸ì€ Deci-AIì—ì„œ ê°œë°œí•œ super-gradientsì˜ **YOLO-NAS-L**ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. ë˜í•œ Person Re-Identification ëª¨ë¸ì€ ë” ë¹ ë¥¸ ì¶”ë¡  ì†ë„ì™€ ë” ì‘ì€ ëª¨ë¸ í¬ê¸°ë¥¼ ë³´ì¥í•˜ê¸° ìœ„í•´ **MobileNetV3**ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.   

## â“‚ï¸ Faiss
 &nbsp;ë©”íƒ€ê°€ ë§Œë“  FaissëŠ” ì—¬ëŸ¬ ë²¡í„° í‘œí˜„ ê°„ì˜ ìœ ì‚¬ì„±ì„ ë¹ ë¥´ê²Œ ê²€ìƒ‰í•  ìˆ˜ ìˆë„ë¡ í•´ì£¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ì…ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì–´ë–¤ ì„ ìˆ˜ê°€ ìŠ›ì„ ì˜ê³  ê³¨ì„ ë„£ì—ˆëŠ”ì§€ íŒŒì•…í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— í•´ë‹¹ í”„ë¡œì íŠ¸ì— ê¼­ í•„ìš”í•œ ë„êµ¬ì…ë‹ˆë‹¤. ì²˜ìŒì—ëŠ” ìœ ì‚¬ì„±ì„ ì¸¡ì •í•˜ê¸° ìœ„í•´ L2 (ìœ í´ë¦¬ë“œ) ê±°ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ í…ŒìŠ¤íŠ¸í•˜ì˜€ê³  ì¢‹ì€ ê²°ê³¼ë¥¼ ì–»ì—ˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì¶”ê°€ ì‹¤í—˜ì„ ê±°ì³ì„œ Cosine Similarityë¥¼ í™œìš©í•œ ê²ƒì´ ë” ë‚˜ì€ ê²°ê³¼ë¥¼ ë„ì¶œí•œë‹¤ëŠ” ê²ƒì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ìš°ë¦¬ëŠ” ìµœì¢…ì ì¸ Cosine Similarityë¥¼ ê²€ìƒ‰ ë°©ë²•ìœ¼ë¡œ ì±„íƒí•˜ê¸°ë¡œ ê²°ì •í•˜ì˜€ìŠµë‹ˆë‹¤

![](assets/faiss.jpg) 

## ğŸ–¼ï¸ Object Detection + Person Re-Identification ì¶”ë¡  ë‹¤ì´ì–´ê·¸ë¨
 &nbsp;ì•„ë˜ëŠ” ìš°ë¦¬ í”„ë¡œì íŠ¸ì˜ íë¦„ì„ ë‚˜íƒ€ë‚´ëŠ” ë‹¤ì´ì–´ê·¸ë¨ì…ë‹ˆë‹¤. ì…ë ¥ í”„ë ˆì„ì´ ì£¼ì–´ì§€ë©´, Detection ëª¨ë¸ì„ í†µí•´ ì„ ìˆ˜, ê³µ, ê³¨ëŒ€, ìŠ›, ê³¨ í´ë˜ìŠ¤ë¥¼ ê°ì§€í•©ë‹ˆë‹¤. ì´ ì¤‘ ì„ ìˆ˜ í´ë˜ìŠ¤ì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¶”ì¶œí•˜ì—¬ Re-ID ëª¨ë¸ì— ì…ë ¥ìœ¼ë¡œ ì œê³µí•©ë‹ˆë‹¤. ì´ì–´ì„œ Re-ID ëª¨ë¸ì€ ê°œê°œì¸ì˜ ì´ë¯¸ì§€ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì„ë² ë”© ë²¡í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. í•´ë‹¹ ë²¡í„°ë“¤ì€ Faissì— ì¶”ê°€ë˜ì–´, ê° ì„ë² ë”© ë²¡í„°ì— í•´ë‹¹í•˜ëŠ” ìƒìœ„ 5ê°œì˜ IDë¥¼ ì–»ì„ ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤. ì´ë ‡ê²Œ ì–»ì–´ì§„ ê²°ê³¼ë“¤ì— ëŒ€í•´ ìµœì¢…ì ìœ¼ë¡œ ê°€ì¥ ë†’ì€ ì‹ ë¢°ë„ë¥¼ ê°€ì§„ IDë¥¼ í™•ì •í•˜ê¸° ìœ„í•´ hard votingì„ í™œìš©í•©ë‹ˆë‹¤.

![](assets/inference_diagram.jpg) 

## ğŸ“ í•™ìŠµ ì‹¤í—˜ ê²°ê³¼
### Object Detection ëª¨ë¸
| Models | Dataset[^1] | Input Dimensions | Epochs | Batch Size (Accumulate) | Optimizer | LR | Loss | Augmentations | F1<sup>val<br>0.5 | mAP<sup>val<br>0.5 | 
| :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: |
| YOLO NAS-L | D1 | (1920,1088) | 50 | 8 <br> (64)  | AdamW | 0.00001 | PPYOLOE | Resize <br>Normalize <br>HorizontalFlip | 0.2811 | 0.6485 |
| **YOLO NAS-L** | **D2** | **(1920,1088)** | **215** | **8 <br> (64)** | **AdamW** | **0.0001** | **PPYOLOE** | **HSV <br> Mosaic <br> RandomAffine <br> HorizontalFlip <br> PaddedRescale <br> Standardize <br>** | **0.8709** | **0.9407** |
[^1]: Dataset D1 and D2 are our own custom datasets. D2 contains 3.1x more data than D1.

<br>

### Person Re-Identification ëª¨ë¸
| Models | Dataset[^2] | Embedded Dimensions | Epochs | Batch Size | Optimizer | LR | Loss | Augmentations | mAP<sup>val |
| :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: |
| MobileNetV3 | R1 | 1000 | 100 | 64 | AdamW | 0.001 | TripletLoss | Resize <br>Normalize <br>HorizontalFlip | 0.9829 |
| MobileVitV2 | R1 | 1000 | 100 | 64 | AdamW | 0.001 | TripletLoss | Resize <br>Normalize <br>HorizontalFlip | 0.9748 |
| ConvNextV2-A | R1 | 1000 | 100 | 64 | AdamW | 0.001 | TripletLoss | Resize <br>Normalize <br>HorizontalFlip | 0.9721 |
| SqueezeNet | R1 | 1000 | 100 | 64 | AdamW | 0.001 | TripletLoss | Resize <br>Normalize <br>HorizontalFlip | 0.9758 |
| MobileNetV3 | R2 | 1000 | 100 | 64 | AdamW | 0.001 | TripletLoss | Resize <br>Normalize <br>HorizontalFlip | 0.8743 |
| MobileNetV3 | R2 | 1000 | 100 | 64 | AdamW | 0.001 | QuadrupletLoss | Resize <br>Normalize <br>HorizontalFlip | 0.9782 |
| SqueezeNetMod[^3] | R2 | 1000 | 500 | 64 | AdamW | 0.001 | QuadrupletLoss | Resize <br>Normalize <br>HorizontalFlip | 0.9857 |
| **MobileNetV3** | **R2** | **1000** | **500** | **64** | **AdamW** | **0.001** | **QuadrupletLoss** | **Resize <br>Normalize <br>HorizontalFlip** | **0.9923** |
[^2]: Dataset R1 and R2 are our own custom datasets. R2 contains little bit more data and identities.
[^3]: SqueezeNet + CBAM with reduction ratio of 8.

## ğŸ› ï¸ ì„¤ì¹˜
```py
git clone https://github.com/boostcampaitech5/level3_cv_finalproject-cv-07.git
cd level3_cv_finalproject-cv-07
conda env create --name <env_name> -f env.yaml
```

## ğŸ—‚ï¸ Dataset ê²½ë¡œ ì„¤ì •
> Object Detection ê²½ë¡œ
 
Datasetì„ ë‹¤ìŒê³¼ ê°™ì€ ê²½ë¡œì— êµ¬ì„±í•´ ì£¼ì„¸ìš”:
1. data íŒŒì¼ëª…ì€ í•™ìŠµì— ì˜í–¥ì„ ë¯¸ì¹˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ json íŒŒì¼ëª…ì€  `train.json`ê³¼ `valid.json`ë¡œ ì„¤ì •í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤. 
```
detection
â”œâ”€â”€ data
â”‚   â”œâ”€â”€ dataset
|   |    â”œâ”€â”€ train
|   |    |   â”œâ”€â”€ <sample1>.jpg
|   |    |   â”œâ”€â”€ <sample2>.jpg
|   |    |   ...
|   |    |   â””â”€â”€ <sample10>.jpg
|   |    â”œâ”€â”€ valid
|   |    |   â”œâ”€â”€ <sample1>.jpg
|   |    |   â”œâ”€â”€ <sample2>.jpg
|   |    |   ...
|   |    |   â””â”€â”€ <sample10>.jpg
|   |    â”œâ”€â”€ train.json
|   |    â””â”€â”€ valid.json
â”‚   â”œâ”€â”€ images
â”‚   â””â”€â”€ video
...
```
<br>

> Person Re-Identifcation ê²½ë¡œ

Datasetì„ ë‹¤ìŒê³¼ ê°™ì€ ê²½ë¡œì— êµ¬ì„±í•´ ì£¼ì„¸ìš”:
1. ê° ë°ì´í„° í•­ëª©ëª…ì„ ë‹¤ìŒê³¼ ê°™ì€ í˜•ì‹ìœ¼ë¡œ êµ¬ì„±í•´ì•¼ í•©ë‹ˆë‹¤ : `xxxxx_xx.jpg` or `xxxxx_xx_xx.jpg`
2. í•´ë‹¹ í˜•ì‹ì—ì„œ ì²˜ìŒ 5ê°œì˜ ìˆ«ìëŠ” ì‚¬ëŒì˜ ID ë²ˆí˜¸ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
```
re_id
â”œâ”€â”€ data
â”‚   â””â”€â”€ custom_dataset
|       â”œâ”€â”€ gallery
|       |   â”œâ”€â”€ <00001_01>.jpg
|       |   â”œâ”€â”€ <00001_02>.jpg
|       |   â”œâ”€â”€ <00002_01>.jpg
|       |   â”œâ”€â”€ <00002_02>.jpg
|       |   ...
|       |   â””â”€â”€ <00010_2>.jpg
|       â”œâ”€â”€ query
|       |   â”œâ”€â”€ <00001_01>.jpg
|       |   â”œâ”€â”€ <00001_02>.jpg
|       |   â”œâ”€â”€ <00002_01>.jpg
|       |   â”œâ”€â”€ <00002_02>.jpg
|       |   ...
|       |   â””â”€â”€ <00010_2>.jpg
|       â””â”€â”€ training
|           â”œâ”€â”€ <00001_01>.jpg
|           â”œâ”€â”€ <00001_02>.jpg
|           â”œâ”€â”€ <00002_01>.jpg
|           â”œâ”€â”€ <00002_02>.jpg
|           ...
|           â””â”€â”€ <00010_2>.jpg
... 
```

<br>

> Magic ê²½ë¡œ

ì´ê³³ì— ì¶”ë¡ í•  ë¹„ë””ì˜¤ë¥¼ ì €ì¥í•´ ì£¼ì„¸ìš”.
```
datasets
â”œâ”€â”€ <video1>.mp4
â”œâ”€â”€ <video2>.mp4
... 
```

## ğŸ‘¨ğŸ»â€ğŸ’» ë‹¨ í•˜ë‚˜ì˜ Command Lineìœ¼ë¡œ í•™ìŠµ ë° ì¶”ë¡ 
### Detection Model í•™ìŠµ
---
```
cd detection/tools
python3 train.py --exp_name exp1 --input_dim (1920,1088) --epochs 100 --lr 0.0001 --batch_size 8 --optimizer AdamW --num_workers 4 --warmup_initial_lr 0.00001 --lr_warmup_epochs 5 --score_thr 0.8 --nms_thr 0.8 -- metric F1@0.50 --fp16 True
```
* --exp_name: ì‹¤í—˜ëª…
* --input_dim: input dimensions
* --epochs: epoch
* --lr: learning rate
* --batch_size: batch size
* --optimizer: optimizer
* --num_workers: dataloader num workers
* --warmup_initial_lr: warmup initial learning rate
* --lr_warmup_epochs: learning rate warmup epochs
* --score_thr: score threshold
* --nms_thr: non-max suppression threshold
* --metric: evaluation metric
* --fp16: mixed precision training

<br>

### Detection Model ì¶”ë¡ 
---
```
cd detection/tools
python3 inference.py --image True --video False --file_name image1.png --conf 0.25 --iou 0.35 --model_weight <your_exp_name>/<your_detection_weight>
```
`image` ë‘ `video` ëŠ” ë™ì‹œì— `True` ë¡œ ì„¤ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!
* --image: image ì¶”ë¡ 
* --video: video ì¶”ë¡ 
* --file_name: ì¶”ë¡ í•  image ë˜ëŠ” video íŒŒì¼
* --conf: confidence threshold
* --iou: iou threshold
* --model_weight: model weight file

<br>

### Person Re-Identification Model í•™ìŠµ
---
```
cd re_id/tools
python3 train.py --demo False --seed 1 --model mobilenetv3 --epoch 100 --train_batch 64 --valid_batch 256 --lr 0.001 --num_workers 8 --quadruplet True --scheduler False --fp16 False
```
* --demo: `True` DeepSportsRadar dataset ì‚¬ìš© |  `False` Custom dataset ì‚¬ìš©
* --seed: seed number
* --model: model. ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ì€ `model.py` ì„ ì°¸ê³ í•´ ì£¼ì„¸ìš”.
* --epoch: epoch
* --train_batch: train batch size
* --valid_batch: valid batch size
* --lr: learning rate
* --num_workers: dataloader num workers
* --quadruplet:  `True` quadruplet loss ì‚¬ìš© | `False` triplet loss ì‚¬ìš©
* --scheduler: lambda scheduler with 0.95**epoch
* --fp16: mixed precision training

<br>

### Person Re-Identification Model ì¶”ë¡ 
---
```
cd re_id/tools
python3 inference.py --demo False --model mobilenetv3 --model_weight <your_reid_weight> --batch_size 256 --num_workers 8 --query_index 0
```
* --demo: `True` DeepSportsRadar dataset ì‚¬ìš© | `False` Custom dataset ì‚¬ìš©
* --model: model
* --model_weight: model weight file
* --batch size: test batch size
* --num worker: dataloader num worker
* --query_index: query index

<br>

### Magic ì¶”ë¡  (ìµœì¢… ê²°ê³¼ ë„ì¶œ)
---
```
python3 magic.py --detection_weight <exp_name>/<your_detection_weight> --reid_weight <your_reid_weight> --video_file <your_video_file> --reid_model mobilenetv3 --person_thr 0.5 --cosine_thr 0.5
```
* --detection_weight: detection model trained weight
* --reid_weight: re-id model trained weight
* --video_file: ì¶”ë¡ í•  video íŒŒì¼
* --reid_model: re-id model
* --person_thr: person confidence threshold
* --cosine_thr: cosine similarity threshold

<br>
  
## ë©¤ë²„
| ê³ ê¸ˆê°• | ê¹€ë™ìš° | ë°•ì¤€ì¼ | ì„ì¬ê·œ | ìµœì§€ìš± |
|:--:|:--:|:--:|:--:|:--:|
|<img  src='https://avatars.githubusercontent.com/u/101968683?v=4'  height=80  width=80px></img>|<img  src='https://avatars.githubusercontent.com/u/113488324?v=4'  height=80  width=80px></img>|<img  src='https://avatars.githubusercontent.com/u/106866130?v=4'  height=80  width=80px></img>|<img  src='https://avatars.githubusercontent.com/u/77265704?v=4'  height=80  width=80px></img>|<img  src='https://avatars.githubusercontent.com/u/78603611?v=4'  height=80  width=80px></img>|
|[Github](https://github.com/TwinKay)|[Github](https://github.com/dwkim8155)|[Github](https://github.com/Parkjoonil)|[Github](https://github.com/Peachypie98)|[Github](https://github.com/guk98)|
|twinkay@yonsei.ac.kr|dwkim8155@gmail.com|joonil2613@gmail.com|jaekyu.1998.bliz@gmail.com|guk9898@gmail.com|